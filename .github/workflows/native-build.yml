name: Build Native + Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (example: v0.1.0)"
        required: true

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: graalvm-community
          java-version: '25'

      - name: Build jar
        run: mvn -B package

      - name: Build native image
        run: |
          native-image \
            --no-fallback \
            --add-modules=java.desktop \
            --initialize-at-run-time=sun.awt.X11.XToolkit \
            -Djava.awt.headless=false \
            -jar target/*.jar \
            iso_downloader

      # ---------- macOS bundle ----------
      - name: Create .app bundle (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p IsoDownloader.app/Contents/MacOS
          mkdir -p IsoDownloader.app/Contents

          cp iso_downloader IsoDownloader.app/Contents/MacOS/

          cat > IsoDownloader.app/Contents/Info.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
          "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>Iso Downloader</string>
              <key>CFBundleExecutable</key>
              <string>iso_downloader</string>
              <key>CFBundleIdentifier</key>
              <string>dev.rishon.isodownloader</string>
              <key>CFBundleVersion</key>
              <string>${{ github.event.inputs.version }}</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
          </dict>
          </plist>
          EOF

      - name: Rename Linux binary
        if: runner.os == 'Linux'
        run: mv iso_downloader iso_downloader-linux

      - name: Create tag
        if: matrix.os == 'ubuntu-latest'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag ${{ github.event.inputs.version }}
          git push origin ${{ github.event.inputs.version }}

      - name: Release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          files: |
            iso_downloader-linux
            IsoDownloader.app
            target/*.jar